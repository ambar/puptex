<!DOCTYPE html>
<html>
<head>
  <title>puptex</title>
</head>
<body>
<script type="text/x-mathjax-config">
// http://docs.mathjax.org/en/latest/options/index.html
MathJax.Hub.Config({
  showMathMenu: false,
  showMathMenuMSIE: false,
  showProcessingMessages: false,
  skipStartupTypeset: true,
  jax: [
    'input/TeX',
    'input/MathML',
    'input/AsciiMath',
    // TODO: 控制不生成 math 元素
    // 'output/NativeMML',
    'output/SVG',
  ],
  TeX: {
    noUndefined: {disabled: true},
    noErrors: {disabled: true},
  },
  SVG: {
    useGlobalCache: false,
    EqnChunk: 1000000,
    EqnDelay: 0,
  },
})

window.onerror = console.warn

// remove delays:
// http://docs.mathjax.org/en/latest/api/hub.html#properties
MathJax.Hub.processSectionDelay = 0
MathJax.Hub.processUpdateTime = 10000000
MathJax.Hub.processUpdateDelay = 0

const globalConfig = {
  ignoreUnknownCharError: true,
}

const registerHooks = (errors) => {
  const events = [
    'AsciiMath Jax - parse error',
    'file load error',
    'Math Processing Error',
    'MathML Jax - parse error',
    'MathML Jax - unknown node type',
    'TeX Jax - parse error',
  ]

  if (!globalConfig.ignoreUnknownCharError) {
    events.push('SVG Jax - unknown char')
  }

  const hooks = events.map(event => (
    MathJax.Hub.Register.MessageHook(event, data => {
      const [type, detail] = data
      console.info(type, detail)
      errors.push(`${type}: ${detail}`)
    })
  ))

  return () => {
    hooks.forEach(hook => {
      MathJax.Hub.UnRegister.MessageHook(hook)
    })
  }
}

const getFrame = (jax) => (
  document.querySelector(`#${jax.inputID}-Frame`)
)

const parseDOMResults = (jax, options) => {
  const frame = getFrame(jax)
  const svg = frame.querySelector('svg')
  // 使其能在浏览器直接打开，而不是被下载
  svg.setAttribute('xmlns', 'http://www.w3.org/2000/svg')
  svg.removeAttribute('aria-hidden')
  svg.style.fontSize = options.fontSize

  const data = {
    svg: svg.outerHTML,
    width: svg.getAttribute('width'),
    height: svg.getAttribute('height'),
    style: svg.getAttribute('style'),
  }

  if (options.mml) {
    const math = frame.querySelector('math')
    data.mml = math ? math.outerHTML : undefined
  }

  return data
}

const parseData = (jax, errors, options) => {
  const data = {}
  if (errors && errors.length) {
    data.errors = errors
  }
  return Object.assign(data, parseDOMResults(jax, options))
}

window.config = (config = {}) => {
  Object.assign(globalConfig, config)
  if (globalConfig.mathJax) {
    MathJax.Hub.Config(globalConfig.mathJax)
  }
}

const scriptSubTypes = {
  TeX: 'tex; mode=display',
  'inline-TeX': 'tex',
  AsciiMath: 'asciimath',
  MathML: 'mml',
}

const formats = [
  // 不需要 `display` 模式，由外部控制即可（如 CSS `display: block, margin: auto`），
  // 图片内嵌时默认就是内联（不设置 'inline-TeX'）
  'TeX',
  'AsciiMath',
  'MathML'
]

const defaultMathOptions = {
  format: 'TeX',
  mml: false,
  svg: true,
  fontSize: '15px',
}

const createMathElement = (math, format) => {
  format = formats.find(f => f.toLowerCase() === format.toLowerCase()) || 'Tex'
  const element = document.createElement('script')
  element.type = 'math/' + scriptSubTypes[format]
  element.textContent = math
  document.body.appendChild(element)
  return element
}

window.renderMath = (math, options) => {
  options = Object.assign({}, defaultMathOptions, options)
  return new Promise((resolve) => {
    MathJax.Hub.Queue(
      () => {
        let errors = []
        let unRegister = registerHooks(errors)
        let element = createMathElement(math, options.format)
        return MathJax.Hub.Typeset(element, () => {
          const jax = MathJax.Hub.getAllJax(element)[0]
          const data = parseData(jax, errors, options)

          // clears global glyphs cache
          // https://github.com/mathjax/MathJax/blob/master/unpacked/jax/output/SVG/jax.js#L413-L424
          MathJax.OutputJax.SVG.resetGlyphs(true)
          MathJax.OutputJax.SVG.Remove(jax)
          unRegister()
          element.remove()
          element = null
          errors = null

          resolve(data)
        })
      },
    )
  })
}

// 触发一次渲染：
// 因为 MathJax 存在一个 bug，如果有 `TeX Jax - parse error`，首次执行时触发 MessageHook 两次
// 另一个解决方式是 `skipStartupTypeset` 设为 `false`，再页面上放置一个空公式
renderMath('')
</script>
</body>
</html>
